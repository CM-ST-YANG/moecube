<img *ngIf="currentCube.cover" class="cover rounded" [src]="currentCube.cover">
<div id="right">
  <h1>{{currentCube.name}}</h1>
  <div id="time">您已玩了 2564 小时</div>

  <!--应用未购买-->
  <div *ngIf="!currentCube.isBought()">

    <button i18n type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#purchase-modal">{{currentCube.price.cny | currency:'CNY':true}} 购买</button>
    <button i18n type="button" (click)="updateInstallOption(currentCube)" class="btn btn-secondary btn-sm" data-toggle="modal" data-target="#install-modal">安装试玩版</button>

    <!--<button i18n (click)="updateInstallOptcurrentCubetApp)" type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#install-modal">我已经购买过</button>-->
  </div>


  <!--应用已购买，未安装-->
  <div *ngIf="currentCube.isBought() && !currentCube.isInstalled()">
    <button i18n (click)="updateInstallOption(currentCube)" type="button" class="btn btn-primary btn-sm" data-toggle="modal" data-target="#install-modal">安装</button>
    <button i18n *ngIf="currentCube.useRun()" (click)="updateInstallOption(currentCube)" type="button" class="btn btn-secondary btn-sm" data-toggle="modal" data-target="#import-modal">导入</button>
  </div>

  <!--应用变更中-->
  <div *ngIf="currentCube.isWorking()">
    <div id="status">
      <span i18n *ngIf="currentCube.isDownloading()">正在下载</span>
      <span i18n *ngIf="currentCube.isInstalling()">正在安装...</span>
      <span i18n *ngIf="currentCube.isUninstalling()">正在卸载...</span>
      <span i18n *ngIf="currentCube.isWaiting()">等待安装...</span>
      <span i18n *ngIf="currentCube.isUpdating()">正在更新...</span>
      <span *ngIf="currentCube.status.total">{{(currentCube.status.progress/currentCube.status.total * 100).toFixed()}}%</span>
      <span>{{currentCube.progressMessage()}}</span>
    </div>
    <progress-bar [value]="currentCube.status.progress / currentCube.status.total"></progress-bar>
  </div>

  <!--应用ready-->
  <ng-container *ngIf="currentCube.isReady()">
    <ng-template #ready>
      <div>
        <button *ngIf="currentCube.useRun()" (click)="runApp(currentCube)" [disabled]="!cubesService.allReady(currentCube)" type="button" class="btn btn-primary btn-sm">
          <i class="fa fa-play" aria-hidden="true"></i> <span i18n>运行</span>
        </button>
        <button i18n *ngIf="currentCube.useCustom()" [disabled]="!cubesService.allReady(currentCube)" (click)="custom(currentCube)" type="button" class="btn btn-secondary btn-sm">设置</button>
        <maotama *ngIf="currentCube.useMaotama()"></maotama>
      </div>
    </ng-template>

    <ygopro *ngIf="currentCube.useYGOPro(); else ready" [currentCube]="currentCube"></ygopro>
  </ng-container>
</div>

<!--安装modal-->
<div class="modal fade" id="install-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" *ngIf="installOption">
  <div class="modal-dialog" role="document">
    <form id="install-form" class="modal-content" (ngSubmit)="install(currentCube,installOption,referencesInstall)" #theForm="ngForm">
      <div class="modal-header">
        <h5 i18n class="modal-title" id="myModalLabel">安装 {{currentCube.name}}</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p i18n>即将开始安装 {{currentCube.name}}</p>
        <h4 i18n>安装位置</h4>
        <div class="form-group">
          <select class="form-control" name="installPath" (change)="selectLibrary()" [(ngModel)]="installOption.installLibrary" title="path">
            <option *ngFor="let library of libraries" value="{{library}}"> {{library}}</option>
            <option *ngFor="let library of availableLibraries" value="create_{{library}}">在 {{library}}\ 盘新建 MoeCube 库
            </option>
          </select></div>
        <h4 i18n>快捷方式</h4>
        <div class="checkbox">
          <input id="create_application_shortcut" type="checkbox" name="application" [(ngModel)]="installOption.createShortcut">
          <label i18n *ngIf="platform == 'darwin'" for="create_application_shortcut">创建 LaunchPad 快捷方式</label>
          <label i18n *ngIf="platform == 'win32'" for="create_application_shortcut">创建开始菜单快捷方式</label>
        </div>
        <div class="checkbox">
          <input id="create_desktop_shortcut" type="checkbox" name="desktop" [(ngModel)]="installOption.createDesktopShortcut">
          <label i18n for="create_desktop_shortcut">创建桌面快捷方式</label>
        </div>
        <h4 i18n *ngIf="references.length>0">扩展内容</h4>
        <div *ngFor="let reference of references"><label>
          <input type="checkbox" [(ngModel)]="referencesInstall[reference.id]" name="references"> {{reference.name}}
        </label></div>
        <div *ngIf="currentCube.findDependencies().length">
          <span i18n>依赖：</span>
          <span class="dependency" *ngFor="let dependency of currentCube.findDependencies()">{{dependency.name}}</span>
        </div>
      </div>
      <div class="modal-footer">
        <button i18n type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
        <button i18n type="submit" [disabled]="!theForm.form.valid" class="btn btn-primary">安装</button>
      </div>
    </form>
  </div>
</div>

<div class="modal fade" id="import-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" *ngIf="installOption">
  <div class="modal-dialog" role="document">
    <form id="import-form" class="modal-content" (ngSubmit)="importGame(currentCube,installOption,referencesInstall)" #theForm="ngForm">
      <div class="modal-header">
        <h5 i18n class="modal-title">导入 {{currentCube.name}}</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <p i18n>选择主程序 {{currentCube.actions.get('main').execute}}</p>
        <label class="custom-file" lang="en">
          <input (click)="$event.preventDefault();selectImport(currentCube)" type="file" id="file" class="custom-file-input">
          <span class="custom-file-control">{{import_path || currentCube.actions.get('main').execute}}</span> </label>

        <h4 i18n>导入到</h4>
        <div class="form-group">
          <select class="form-control" name="installPath" (change)="selectLibrary()" [(ngModel)]="installOption.installLibrary" title="path">
            <option *ngFor="let library of libraries" value="{{library}}">{{library}}</option>
            <option *ngFor="let library of availableLibraries" value="create_{{library}}">在 {{library}}\ 盘新建 MoeCube 库</option>
          </select>
        </div>
        <!--<h4 i18n>快捷方式</h4>-->
        <!--<div class="checkbox">-->
        <!--<input id="create_application_shortcut" type="checkbox" name="application" [(ngModel)]="installOption.createShortcut">-->
        <!--<label i18n *ngIf="platform == 'darwin'" for="create_application_shortcut">创建 LaunchPad 快捷方式</label>-->
        <!--<label i18n *ngIf="platform == 'win32'" for="create_application_shortcut">创建开始菜单快捷方式</label>-->
        <!--</div>-->
        <!--<div class="checkbox">-->
        <!--<input id="create_desktop_shortcut" type="checkbox" name="desktop" [(ngModel)]="installOption.createDesktopShortcut">-->
        <!--<label i18n for="create_desktop_shortcut">创建桌面快捷方式</label>-->
        <!--</div>-->
        <h4 i18n *ngIf="references.length>0">扩展内容</h4>
        <div *ngFor="let reference of references"><label>
          <input type="checkbox" [(ngModel)]="referencesInstall[reference.id]" name="references"> {{reference.name}}
        </label></div>
        <div *ngIf="currentCube.findDependencies().length">
          <span i18n>依赖：</span>
          <span class="dependency" *ngFor="let dependency of currentCube.findDependencies()">{{dependency.name}}</span>
        </div>
      </div>
      <div class="modal-footer">
        <button i18n type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
        <button i18n type="submit" [disabled]="import_path && !theForm.form.valid" class="btn btn-primary">导入</button>
      </div>
    </form>
  </div>
</div>


<div class="modal fade" id="purchase-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" *ngIf="!currentCube.isBought()">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 i18n class="modal-title">购买 {{currentCube.name}}</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span>&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <!--<div class="form-group">-->
        <!--<label for="exampleSelect1">国家/地区</label>-->
        <!--<select class="form-control" id="exampleSelect1">-->
        <!--<option>中国(￥）</option>-->
        <!--<option>美国($）</option>-->
        <!--<option>3</option>-->
        <!--<option>4</option>-->
        <!--<option>5</option>-->
        <!--</select>-->
        <!--</div>-->
        <div class="d-flex justify-content-between">
          <img *ngIf="currentCube.cover" [src]="currentCube.cover" class="banner">
          <span class="p-2">{{currentCube.name}}</span>
          <span class="p-2 ml-auto">{{currentCube.price.cny | currency:'CNY':true}}</span>
        </div>
        <form id="purchase-form" class="form-inline">
          <!--<fieldset class="form-group">-->
          <legend>支付方式</legend>
          <div class="form-check">
            <input [(ngModel)]="payment" id="alipay" type="radio" class="form-check-input" name="payment" value="alipay" checked>
            <label for="alipay" class="form-check-label">支付宝</label>
          </div>
          <div class="form-check">
            <input [(ngModel)]="payment" id="wechat" type="radio" class="form-check-input" name="payment" value="wechat" checked>
            <label for="wechat" class="form-check-label">微信</label>
          </div>
          <!--<div class="form-check">-->
          <!--<input id="paypal" type="radio" class="form-check-input" name="optionsRadios" value="alipay" checked>-->
          <!--<label for="paypal" class="form-check-label">PayPal</label>-->
          <!--</div>-->
          <!--</fieldset>-->
        </form>

      </div>
      <div class="modal-footer">
        <button i18n class="btn btn-secondary" data-dismiss="modal">取消</button>
        <button i18n [disabled]="creating_order" class="btn btn-primary" (click)="purchase()">购买</button>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="purchase-modal-alipay" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static" *ngIf="!currentCube.isBought()">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 i18n class="modal-title">购买 {{currentCube.name}}</h5>
        <!--<button type="button" class="close" data-dismiss="modal" aria-label="Close">-->
        <!--<span>&times;</span>-->
        <!--</button>-->
      </div>
      <div class="modal-body">
        订单已经创建，请在新窗口中进行支付，支付成功后页面会自动跳转

        若支付成功后没有自动跳转 请联系 admin@moecube.com 若支付失败，请返回并选择其他支付方式
      </div>
      <div class="modal-footer">
        <button i18n type="button" class="btn btn-secondary" data-dismiss="modal">返回</button>
      </div>
    </div>
  </div>
</div>
